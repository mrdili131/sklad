<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sklad | Mahsulotlar</title>
</head>
<body>

<div class="app">

    <!-- ORIGINAL SIDEBAR (REVERTED) -->
    {% include 'navbar.html' %}

    <!-- CONTENT -->
    <main class="content">
        <h1>Mahsulotlar</h1>
        <form class="search-form" action="" method="get">
            <input
                type="search"
                name="q"
                id="searchInput"
                placeholder="Mahsulot nomi bo‚Äòyicha qidirish‚Ä¶"
                autocomplete="off"
            >
            <button type="submit" id="searchInput">üîç Izlash</button>
        </form>

        <div class="alert hidden"></div>

        <!-- TABLE HEADER -->
        <div class="table-header">
            <span>Nomi</span>
            <span>Miqdor</span>
            <span>Sanoq turi</span>
            <span>Narxi</span>
            <span>Jami</span>
            <span>Amallar</span>
        </div>

        <div class="products_all">
            <!-- STATIC PRODUCTS -->

            <!-- Products here -->
            <!-- Products here -->
            <!-- Products here -->

        </div>

    </main>
</div>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",sans-serif}
body{background:#f4f6f8}
.app{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{
    width:260px;
    background:#1e293b;
    color:#fff;
    padding:25px;
    transition:.3s;
}
.logo{text-align:center;margin-bottom:40px;font-size:26px}
.sidebar nav{display:flex;flex-direction:column;gap:15px}
.sidebar a{
    display:flex;
    align-items:center;
    gap:14px;
    color:#cbd5e1;
    text-decoration:none;
    font-size:18px;
    padding:10px 15px;
    border-radius:10px;
    transition:.2s;
}
.sidebar a span{font-size:22px;min-width:26px;text-align:center}
.sidebar a.active,
.sidebar a:hover{
    background:#334155;
    color:#fff;
}
.logout{
    margin-top:40px;
    background:#7f1d1d;
    color:#fecaca!important;
}

/* CONTENT */
.content{flex:1;padding:40px}
h1{margin-bottom:20px}

/* TABLE */
.table-header,
.product-row{
    display:grid;
    grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
    gap:10px;
    align-items:center;
}

.table-header{
    font-weight:600;
    color:#475569;
    margin-bottom:10px;
}

.product-row{
    background:#fff;
    padding:12px;
    border-radius:12px;
    margin-bottom:10px;
}

.actions{
    display:flex;
    gap:6px;
}

.actions button{
    border:none;
    padding:7px 10px;
    border-radius:8px;
    cursor:pointer;
    color:white;
}

.edit{background:#2563eb}
.delete{background:#dc2626}

/* ALERT */
.alert{padding:12px;border-radius:10px;margin-bottom:15px}
.alert.success{background:#dcfce7;color:#166534}
.alert.error{background:#fee2e2;color:#7f1d1d}
.hidden{display:none}
.search-form{
    display:flex;
    gap:10px;
    margin-bottom:20px;
}

.search-form input{
    flex:1;
    padding:10px 14px;
    border-radius:10px;
    border:1px solid #cbd5e1;
    font-size:15px;
    outline:none;
    transition:.2s;
}

.search-form input:focus{
    border-color:#2563eb;
    box-shadow:0 0 0 2px rgba(37,99,235,.15);
}

.search-form button{
    padding:10px 18px;
    border:none;
    border-radius:10px;
    background:#2563eb;
    color:white;
    font-size:15px;
    cursor:pointer;
    transition:.2s;
}

.search-form button:hover{
    background:#1d4ed8;
}


/* MOBILE */
@media(max-width:768px){
    .sidebar{width:70px;padding:15px 8px}
    .sidebar a{justify-content:center}
    .sidebar a b{display:none}

    .content{padding:20px 15px}
    .table-header{display:none}

    .product-row{
        grid-template-columns:1fr;
        gap:6px;
    }

    .actions button{width:100%}
}
</style>
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

</body>
</html>


<script>

const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
const searchInput = document.getElementById("searchInput");

async function get_products(){
    const response = await fetch(`/api/products`);
    const data = await response.json();

    let products_div = document.querySelector('.products_all')
    products_div.innerHTML = ``;

    data.forEach(i=>{
        products_div.innerHTML += `
        <div class="product-row" id="product_${i.id}">
            <span>${i.name}</span>
            <span>${i.quantity}</span>
            <span>${i.p_type}</span>
            <span>${(i.price).toLocaleString()} so‚Äòm</span>
            <span><b>${(Number(i.price)*Number(i.quantity)).toLocaleString()} so‚Äòm</b></span>
            <div class="actions">
                <a href="/product/${i.id}" style="border-radius:7px;padding:5px;text-decoration:none;" class="edit">‚úèÔ∏è</a>
                <button class="delete" onclick="delete_product(${i.id})">üóë</button>
            </div>
        </div>
        `
    })
}

async function delete_product(id){
    await fetch(`/api/product/${id}/`,
    {
        method:"DELETE",
        headers:{'X-CSRFToken': csrftoken,}   // important!
    });
    document.getElementById(`product_${id}`).remove()
}

searchInput.addEventListener("input", function(){
    const value = this.value.toLowerCase().trim();
    const products = document.querySelectorAll(".product-row");

    products.forEach(row=>{
        const name = row.querySelector("span").innerText.toLowerCase();

        if(name.includes(value)){
            row.style.display = "grid";
        }else{
            row.style.display = "none";
        }
    });
});

// Initializing functions
get_products()
</script>
