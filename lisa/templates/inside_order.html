{% load humanize %}
<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buyurtma | {{order.uuid}}</title>
</head>
<body>

<div class="app">

    <!-- SIDEBAR -->
    {% include 'navbar.html' %}

    <!-- CONTENT -->
    <main class="content">

        <h1>Buyurtma: {{order.uuid}}</h1>

        <!-- ORDER INFO -->
        <div class="card">
            <div class="info-row">
                <div><b>Sana:</b> {{order.created_at}}</div>
                {% if order.status == 'sotilgan' %}
                    <div class="status paid">To‘langan</div>
                    <button onclick="revert_order()">Qaytarish</button>
                {% else %}
                    <div class="status returned">Qaytarilgan</div>
                    <button onclick="revert_order()" disabled style="background-color: #a74141;">Qaytarish</button>
                {% endif %}
            </div>
        </div>

        <!-- PRODUCTS -->
        <div class="card">
            <h3>Mahsulotlar</h3>

            <table>
                <thead>
                    <tr>
                        <th>Mahsulot</th>
                        <th>Soni</th>
                        <th>Narx</th>
                        <th>Jami</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in order.items.all %}
                    <tr>
                        <td>{{item.product.name}}</td>
                        <td>{{item.quantity}}</td>
                        <td>{{item.price|intcomma}} so‘m</td>
                        <td>{{item.total_price|intcomma}} so‘m</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="total-box">
                Jami: {{order.sold_price|intcomma}} so‘m
            </div>
        </div>

    </main>
</div>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",sans-serif}
body{background:#f4f6f8}
.app{display:flex;min-height:100vh}

/* ================= SIDEBAR ================= */
.sidebar{
    width:260px;
    background:#1e293b;
    color:#fff;
    padding:25px;
    transition:.3s
}

.logo{
    text-align:center;
    margin-bottom:40px;
    font-size:26px
}

.sidebar nav{
    display:flex;
    flex-direction:column;
    gap:15px
}

.sidebar a{
    display:flex;
    align-items:center;
    gap:14px;
    color:#cbd5e1;
    text-decoration:none;
    font-size:18px;
    padding:10px 15px;
    border-radius:10px
}

.sidebar a span{
    font-size:22px;
    min-width:26px;
    text-align:center
}

.sidebar a.active,
.sidebar a:hover{
    background:#334155;
    color:#fff
}

.logout{
    margin-top:40px;
    background:#7f1d1d;
    color:#fecaca!important
}

/* ================= CONTENT ================= */
.content{
    flex:1;
    padding:40px
}

h1{
    margin-bottom:20px
}

/* ================= CARDS ================= */
.card{
    background:#fff;
    padding:20px;
    border-radius:15px;
    margin-bottom:20px;
    box-shadow:0 10px 25px rgba(0,0,0,.08)
}

.info-row{
    display:flex;
    justify-content:space-between;
    margin-bottom:10px
}

.status{
    padding:6px 12px;
    border-radius:20px;
    font-size:14px;
    font-weight:600
}

.status.paid{
    background:#dcfce7;
    color:#16a34a
}

.status.returned{
    background:#dadadaa3;
    color:#3f3f3f
}
/* ================= TABLE ================= */
table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px
}

th,td{
    padding:12px;
    border-bottom:1px solid #e5e7eb;
    text-align:left
}

th{
    background:#f1f5f9
}

tr:hover{
    background:#f8fafc
}

.total-box{
    margin-top:15px;
    text-align:right;
    font-size:18px;
    font-weight:700
}
button{padding:10px 18px;border-radius:10px;border:none;cursor:pointer;background:#eb2525;color:white}
/* ================= PRINT ================= */
@media print{
    .sidebar{display:none}
    body{background:white}
    .content{padding:0}
}

/* ================= MOBILE ================= */
@media(max-width:768px){

    .sidebar{
        width:70px;
        padding:15px 8px
    }

    .sidebar a{
        justify-content:center
    }

    .sidebar a b{
        display:none
    }

    .logo{
        font-size:24px
    }

    .content{
        padding:20px 15px
    }

    thead{
        display:none
    }

    tbody tr{
        display:block;
        background:#f8fafc;
        margin-bottom:12px;
        padding:14px;
        border-radius:14px;
        box-shadow:0 5px 15px rgba(0,0,0,.05)
    }

    tbody td{
        display:flex;
        justify-content:space-between;
        padding:6px 0;
        border:none;
        font-size:14px
    }

    tbody td::before{
        font-weight:600;
        color:#64748b
    }

    tbody td:nth-child(1)::before{content:"Mahsulot";}
    tbody td:nth-child(2)::before{content:"Soni";}
    tbody td:nth-child(3)::before{content:"Narx";}
    tbody td:nth-child(4)::before{content:"Jami";}
}
</style>
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
</body>
</html>

<script>

const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

async function revert_order(){
    await fetch(`/api/order-revert/`,
    {
        method:"DELETE",
        headers:{
            "Content-Type": "application/json",
            'X-CSRFToken': csrftoken,
        },
        body:JSON.stringify({
            uuid:"{{order.uuid}}"
        }),
    });
    window.location.reload()
}
</script>
