<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sklad | Chiqim</title>
</head>
<body>

<div class="app">

    <!-- SIDEBAR -->
    {% include 'navbar.html' %}

    <!-- CONTENT -->
    <main class="content">
        <h1>Mahsulot chiqim qilish</h1>
        <div id="alert" class="alert hidden"></div>

        <!-- ADD PRODUCT -->
        <div class="card">
            <h3>Mahsulot qo‘shish</h3>
            <div class="row">
                <select id="productSelect">
                    <option value="" id="product_selection">Mahsulot tanlang</option>
                    {% for i in products %}
                        <option value="{{i.id}}" data-price="{{i.price}}">{{i.name}}</option>
                    {% endfor %}
                </select>
                <input type="number" value="1" id="quantity" placeholder="Soni">
                <input type="text" id="price" placeholder="Narxi" disabled>
                <input type="number" id="selling_price" placeholder="Sotuv narxi">
                <button onclick="to_cart()">➕</button>
            </div>
        </div>

        <!-- CART -->
        <div class="card">
            <h3>Chiqim ro‘yxati</h3>
            <table>
                <thead>
                    <tr>
                        <th>Mahsulot</th>
                        <th>Narx</th>
                        <th>Soni</th>
                        <th>Jami</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="cartBody"></tbody>
            </table>
            <div class="total">
                Umumiy summa: <span id="grandTotal">0</span> so‘m
            </div>
            <button class="danger" onclick="submitChiqim()">➖ Chiqim qilish</button>
        </div>
    </main>
</div>
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
</body>
</html>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",sans-serif}
body{background:#f4f6f8}
.app{display:flex;min-height:100vh}

/* Sidebar */
.sidebar{width:260px;background:#1e293b;color:#fff;padding:20px 15px;transition:.3s}
.logo{text-align:center;font-size:26px;margin-bottom:30px}
.sidebar nav{display:flex;flex-direction:column;gap:12px}
.sidebar a{display:flex;align-items:center;gap:14px;color:#cbd5e1;text-decoration:none;padding:12px;border-radius:12px;font-size:18px}
.sidebar a span{font-size:22px;min-width:26px;text-align:center}
.sidebar a.active,.sidebar a:hover{background:#334155;color:#fff}
.logout{margin-top:30px;background:#7f1d1d}

/* Content */
.content{flex:1;padding:40px}
h1{margin-bottom:20px}

/* Cards */
.card{background:#fff;padding:20px;border-radius:15px;margin-bottom:25px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
select,input{flex:1;padding:12px;border-radius:10px;border:1.5px solid #cbd5e1;font-size:16px}
button{padding:12px 18px;border-radius:12px;border:none;background:#2563eb;color:white;font-size:16px;cursor:pointer}
button:hover{background:#1d4ed8}
.danger{background:#ef4444;margin-top:15px}
.danger:hover{background:#dc2626}

/* Table */
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left}
.total{text-align:right;font-size:20px;font-weight:700;margin-top:15px}

/* Alerts */
.alert{padding:12px;border-radius:10px;margin-bottom:15px}
.alert.success{background:#dcfce7;color:#166534}
.alert.error{background:#fee2e2;color:#7f1d1d}
.hidden{display:none}

/* Mobile */
@media(max-width:768px){
    .sidebar{width:70px;padding:15px 8px}
    .sidebar a{justify-content:center}
    .sidebar a b{display:none}
    .logo{font-size:24px}
    .content{padding:20px 15px}

    /* Mobile cart: table -> cards */
    table, thead{display:none}
    tbody tr{display:block;background:#f8fafc;margin-bottom:10px;padding:12px;border-radius:12px}
    tbody td{display:flex;justify-content:space-between;padding:4px 0;border:none}
    tbody td:last-child{justify-content:flex-end}
}
</style>

<script>
const select=document.getElementById("productSelect");
const cartBody=document.getElementById("cartBody");
const grandTotalEl=document.getElementById("grandTotal");
const alertBox=document.getElementById("alert");

const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;


function showAlert(m,t){
    alertBox.textContent=m;
    alertBox.className=`alert ${t}`;
    alertBox.classList.remove("hidden");
    setTimeout(()=>alertBox.classList.add("hidden"),3000);
}

document.getElementById("productSelect").addEventListener("change",function(){
    const product_cost = this.value;
    const opt = this.options[this.selectedIndex]
    const price = opt.dataset.price;
    document.getElementById("price").value = `${Number(price).toLocaleString()} so‘m`;
})

function to_cart(){
    let selling_price = document.getElementById("selling_price").value
    let prod_id = document.getElementById("productSelect").value
    let quantity = document.getElementById("quantity").value

    if (!selling_price || !prod_id || !quantity){
        alert("Bo‘sh kataklarni to‘ldiring !!!")
        return
    }

    fetch("/api/cart/",{
        method:"POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body:JSON.stringify({
            product_id:prod_id,
            quantity:quantity,
            selling_price:selling_price
        })
    })
    .then(response => response.json())
    .then(data => {
        // console.log("Cart response:", data);
    })
}
</script>
